<?php
/**
 * Created by Vasiliy Ivanov
 * client: Bank SIAB
 * Version: 0.0.1
 * Date: 21.09.2018
 * email: vasilisko@gmail.com
 */

class eCommerce {
  var $result = array();
  var $config;
  var $log    = array();
  var $curlData;

  function __construct($configNew = array()) {
    $this->result = array(
      'status'   => 'error',
      'data'     => array(),
      'response' => array()
    );
    $this->config = array(
      'url'                    => '',             // адрес для выполнения запроса
      'merchantid'             => '',
      'area'                   => 'development',  // development / production
      'logShow'                => FALSE,          // write / print / FALSE
      'logCurl'                => 'standart',     // standart / full
      'dirLog'                 => 'log',
      'dirCert'                => '',
      'data'                   => 'json',         // json / text формат возврата данных
      'curl_referer'           => '',
      'curl_Ssl'               => FALSE,          // отправка сертификата
      'curl_sslVerifypeer'     => FALSE,
      'curl_timeout'           => '5',            // максимальное количество секунд для выполнения функций cURL.
      'curl_connectionTimeout' => '2',            // количество секунд ожидания при попытке подключения.
      'curl_header'            => array(
        'Content-Type' => 'text/xml'
      )
    );

    if (is_array($configNew) && count($configNew)) {
      foreach ($configNew as $key => $value) {
        $this->config[$key] = $value;
      }
    }

    $this->checkConfig();
  }

  function exec_CreateOrder_GetOrderStatus() {
    $this->log[] = 'Выполняется GetOrderStatus';

    $xml = array();
    $xml[] = '<TKKPG>';
    $xml[] = '<Request>';
    $xml[] = '<Operation>GetOrderStatus</Operation>';
    $xml[] = '<Language>' . $this->config['language'] . '</Language>';
    $xml[] = '<Order>';
    $xml[] = '<Merchant>' . $this->config['merchantid'] . '</Merchant>';
    $xml[] = '<OrderID>' . $_POST['OrderID'] . '</OrderID>';
    $xml[] = '</Order>';
    $xml[] = '<SessionID>' . $_POST['SessionID'] . '</SessionID>';
    $xml[] = '</Request>';
    $xml[] = '</TKKPG>';

    $xmlSend = implode('', $xml);

    $this->curlExecute($xmlSend);

    $order = $this->result['response']['Order'];
    if (!$order['OrderID'] || !$order['OrderStatus']) {
      $this->returnWithError('response');
    }

    $this->result['data'] = array(
      'OrderID'       => $order['OrderID'],
      'OrderStatus'   => $order['OrderStatus']
    );
    $this->result['operation'] = $this->result['response']['Operation'];
    $this->result['status'] = 'accept';
    return $this->returnResult();
  }

  function exec_CreateOrder_QuasiCash() {
    $this->log[] = 'Выполняется QuasiCash';

    $xml = array();
    $xml[] = '<TKKPG>';
    $xml[] = '<Request>';
    $xml[] = '<Operation>CreateOrder</Operation>';
    $xml[] = '<Language>' . $this->config['language'] . '</Language>';
    $xml[] = '<Order>';
    $xml[] = '<OrderType>QuasiCash</OrderType>';
    $xml[] = '<Merchant>' . $this->config['merchantid'] . '</Merchant>';
    $xml[] = '<Amount>' . $_POST['amount'] . '</Amount>';
    $xml[] = '<Currency>' . $_POST['currency'] . '</Currency>';
    $xml[] = '<Description>' . $_POST['description'] . '</Description>';
    $xml[] = '<ApproveURL>' . $_POST['approveurl'] . '</ApproveURL>';
    $xml[] = '<CancelURL>' . $_POST['cancelurl'] . '</CancelURL>';
    $xml[] = '<DeclineURL>' . $_POST['declineurl'] . '</DeclineURL>';
    $xml[] = '<AddParams>';
    $xml[] = '<OrigAmount>' . $_POST['OrigAmount'] . '</OrigAmount>';
    $xml[] = '<OrigCurrency>' . $_POST['OrigCurrency'] . '</OrigCurrency>';
    $xml[] = '</AddParams>';
    $xml[] = '</Order>';
    $xml[] = '</Request>';
    $xml[] = '</TKKPG>';

    $xmlSend = implode('', $xml);

    $this->curlExecute($xmlSend);

    $order = $this->result['response']['Order'];
    if (!$order['OrderID'] || !$order['SessionID'] || !$order['URL']) {
      $this->returnWithError('response');
    }

    $this->result['data'] = array(
      'URL'       => $order['URL'],
      'OrderID'   => $order['OrderID'],
      'SessionID' => $order['SessionID'],
      'urlFull'   => $order['URL'] . '?OrderID=' . $order['OrderID'] . '&SessionID=' . $order['SessionID']
    );
    $this->result['operation'] = $this->result['response']['Operation'];
    $this->result['status'] = 'accept';
    return $this->returnResult();
  }

  function exec_CreateOrder_Purchase() {
    $this->log[] = 'Выполняется CreateOrder';

    $xml = array();
    $xml[] = '<TKKPG>';
    $xml[] = '<Request>';
    $xml[] = '<Operation>CreateOrder</Operation>';
    $xml[] = '<Language>' . $this->config['language'] . '</Language>';
    $xml[] = '<Order>';
    $xml[] = '<Merchant>' . $this->config['merchantid'] . '</Merchant>';
    $xml[] = '<OrderType>Purchase</OrderType>';
    $xml[] = '<Amount>' . $_POST['amount'] . '</Amount>';
    $xml[] = '<Currency>' . $_POST['currency'] . '</Currency>';
    $xml[] = '<Description>' . $_POST['description'] . '</Description>';
    $xml[] = '<ApproveURL>' . $_POST['approveurl'] . '</ApproveURL>';
    $xml[] = '<CancelURL>' . $_POST['cancelurl'] . '</CancelURL>';
    $xml[] = '<DeclineURL>' . $_POST['declineurl'] . '</DeclineURL>';
    $xml[] = '<AddParams>';
    $xml[] = '<OrigAmount/>';
    $xml[] = '<OrigCurrency/>';
    $xml[] = '</AddParams>';
    $xml[] = '</Order>';
    $xml[] = '</Request>';
    $xml[] = '</TKKPG>';

    $xmlSend = implode('', $xml);

    $this->curlExecute($xmlSend);

    $order = $this->result['response']['Order'];
    if (!$order['OrderID'] || !$order['SessionID'] || !$order['URL']) {
      $this->returnWithError('response');
    }

    $this->result['data'] = array(
      'URL'       => $order['URL'],
      'OrderID'   => $order['OrderID'],
      'SessionID' => $order['SessionID'],
      'urlFull'   => $order['URL'] . '?OrderID=' . $order['OrderID'] . '&SessionID=' . $order['SessionID']
    );
    $this->result['operation'] = $this->result['response']['Operation'];
    $this->result['status'] = 'accept';
    return $this->returnResult();
  }

  private function returnWithError($type = '') {
    $this->result['status'] = 'error';
    if ($type == 'status') {
      $type = 'by response status';
      $this->result['data']['status'] = $this->result['response']['Status'];
    } else if ($type == 'curl') {
      $type = 'execute error';
    } else if ($type == 'response') {
      $this->log[] = 'Получена не вся информация от Банка';
    } else if ($type == 'data') {
      $this->log[] = 'Не получена информация от Банка';
    }

    $this->log[] = 'ОШИБКА ' . $type;
    $this->showLog();
    echo $this->returnResult();
    die();
  }

  private function curlExecute($xml) {

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $this->config['url']);
    curl_setopt($ch, CURLOPT_REFERER, $this->config['curl_referer']);
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
    curl_setopt($ch, CURLOPT_HEADER, 0);
    curl_setopt($ch, CURLOPT_HTTPHEADER, $this->returnHeader($this->config['curl_header']));
    curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, $this->config['curl_connectionTimeout']);
    curl_setopt($ch, CURLOPT_TIMEOUT, $this->config['curl_timeout']);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_POST, 1);
    curl_setopt($ch, CURLOPT_POSTFIELDS, $xml);

    // TODO доделать работу с сертификатами
    if ($this->config['curl_Ssl']) {

      $certificateRequest = $this->config['dirCert'] . 'name.csr';  // CERTIFICATE REQUEST
      $certificate = $this->config['dirCert'] . 'test.crt';         // CERTIFICATE
      $privateKey = $this->config['dirCert'] . 'test.key';          // PRIVATE KEY

      curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE); //  запретит проверки сертификата удаленного сервера
      curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 2);     //  1 означает проверку существования имени, значение 2 - кроме того, и проверку соответствия имени хоста.
      curl_setopt($ch, CURLOPT_SSLKEY, $privateKey);
      curl_setopt($ch, CURLOPT_SSLCERT, $certificate);
      //curl_setopt($ch, CURLOPT_CAINFO, $certificateRequest);

      $this->log[] = 'Подключение сертификатов:';
      $this->log[] = 'CERTIFICATE: ' . $certificate;
      $this->log[] = 'PRIVATE KEY: ' . $privateKey;
    }


    $logExecute = array();
    $time['start'] = microtime(1);
    $result = array(
      'main'      => curl_exec($ch),
      'getinfo'   => curl_getinfo($ch),
      'errno'     => curl_errno($ch),
      'error'     => curl_error($ch),
      'status'    => 'access',
      'time_work' => '0'
    );

    curl_close($ch);

    $time['end'] = microtime(1);
    $result['time_work'] = round($time['end'] - $time['start'], 2);

    if (($result['errno'] || $result['getinfo']['http_code'] > 200)) {
      $result['status'] = 'error';
      $result['err_status'] = 2;
      if ($result['errno']) {
        $result['err_text'] = ' Error #' . $result['errno'] . ': ' . $result['error'] . '. ';
      }
      if ($result['getinfo']['http_code'] > 200) {
        $result['err_text'] = ' Http code: ' . $result['getinfo']['http_code'] . '. ';
      }
      $result['err_text'] .= ' Host: ' . $result['getinfo']['url'];
    }

    $logExecute[] = '- Status: <b>' . $result['status'] . '</b>. ';

    if ($result['errno']) {
      $logExecute[] = '- Error #' . $result['errno'] . ': ' . $result['error'] . '. ';
    }
    if ($result['getinfo']['http_code']) {
      $logExecute[] = '- Http code: ' . $result['getinfo']['http_code'] . '. ';
    }
    if ($result['time_work']) {
      $logExecute[] = '- Time script: ' . $result['time_work'] . ' sec. ';
    }
    if ($result['getinfo']['url']) {
      $logExecute[] = '- Url: ' . $result['getinfo']['url'] . '. ';
    }

    if ($this->config['logShow']) {
      $this->log[] = 'curl Execute';
      $this->log[] = '<br>' . implode('<br>', $logExecute);
    }

    if ($this->config['logCurl'] == 'full') {
      if ($xml) {
        $this->log[] = '$xml:<br><textarea>' . $xml . '</textarea>';
      }
      if (is_array($result) && count($result)) {
        $this->log[] = 'mainData:<br><textarea>' . print_r($result, TRUE) . '</textarea>';
      }
      if ($result['main']) {
        $this->log[] = 'main:<br><textarea>' . $result['main'] . '</textarea>';

      }
      if ($result['getinfo']) {
        $this->log[] = 'getinfo:<br><textarea>' . print_r($result['getinfo'], TRUE) . '</textarea>';
      }
      if ($result['response']) {
        $this->log[] = 'response:<br><textarea>' . print_r($this->result['response'], TRUE) . '</textarea>';
      }

      if ($result['error'] && $this->config['showError']) {
        $this->log[] = $result['error']['message'] . '(' . $result['error']['code'] . ')';
      }
    }

    if ($result) {
      if ($result['error']) {
        $this->returnWithError('curl');
      } else {
        $this->result['response'] = $this->convertXmlToArray($result['main'])['Response'];
        if ($this->result['response']['Status'] != '00') {
          $this->returnWithError('status');
        }
        return TRUE;
      }
    } else {
      $this->returnWithError('data');
    }
    return FALSE;
  }

  private function convertXmlToArray($xml) {
    libxml_use_internal_errors(TRUE);
    $xml ? $result = json_decode(json_encode(simplexml_load_string($xml)), TRUE) : $result = FALSE;
    return $result;
  }

  private function showLog() {
    if ($this->config['logShow']) {
      $this->result['log'] = implode('<br>', $this->log);
    }
  }

  private function returnResult() {
    unset($this->result['response']);
    $this->showLog();
    if ($this->config['data'] == 'json') {
      return $this->returnResultJson();
    } else {
      return $this->result;
    }
  }

  private function returnResultJson() {
    return json_encode($this->result, TRUE);
  }

  private function returnHeader($array) {
    $headerArray = array();
    if (is_array($array)) {
      foreach ($array as $sParam => $sVal) {
        $headerArray[] = $sParam . ': ' . $sVal;
      }
    }
    return $headerArray;
  }

  private function checkConfig() {
    $configCheck = TRUE;
    $textError[] = '<b color="red">Config error</b>. ';
    if (!$this->config['url']) {
      $configCheck = FALSE;
      $textError[] = 'Не указан <b>url</b>';
    }
    if (!$this->config['merchantid']) {
      $configCheck = FALSE;
      $textError[] = 'Не указан <b>merchantid</b>';
    }
    if ($this->config['curl_Ssl'] && (!$this->config['dirCert'] || !is_dir($this->config['dirCert']))) {
      $configCheck = FALSE;
      $textError[] = 'Не указан <b>dirCert</b> или путь не найден';
      $textError[] = 'dir: ' . $this->config['dirCert'];
    }

    if (!$configCheck) {
      foreach ($textError as $item) {
        $this->log[] = $item;
      }
      $this->returnWithError('check config');
    }
  }
}